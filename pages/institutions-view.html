<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Institution Details - Q1KEY Platform</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/i18n.js"></script>
</head>
<body>
  <div id="sidebar"></div>
  
  <div class="main-content">
    <div id="header"></div>
    
    <div class="page-content">
      <!-- Page Header -->
      <div class="flex items-center gap-3 mb-8" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
        <a href="institutions.html" class="btn btn-secondary" style="padding: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-white" data-i18n-key="institutions.view_institution">Institution Details</h1>
          <p class="text-secondary" data-i18n-key="institutions.view_institution_info">View institution information</p>
        </div>
      </div>
      
      <!-- Loading -->
      <div id="loadingContainer" class="loading-container">
        <div class="spinner"></div>
      </div>
      
      <!-- Institution Details -->
      <div id="institutionContainer" style="display: none;">
        <div class="glass-card p-6 mb-6">
          <div class="flex items-center justify-between mb-6" style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1.5rem;">
            <div>
              <h2 id="institutionName" class="text-2xl font-bold text-white mb-2"></h2>
              <p class="text-muted"><span data-i18n-key="institutions.view_page.institution_id">Institution ID</span>: <span id="institutionId"></span></p>
            </div>
            <div class="flex gap-2" style="display: flex; gap: 0.5rem;">
              <span id="statusBadge" class="badge"></span>
              <a id="editBtn" class="btn btn-primary" data-i18n-key="common.button.edit">Edit</a>
              <button id="deleteBtn" class="btn btn-danger" data-i18n-key="common.button.delete">Delete</button>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-6" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.tax_id">Tax ID</p>
              <p id="taxId" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.phone_number">Phone Number</p>
              <p id="phoneNumber" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.email">Email</p>
              <p id="email" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.max_users">Max Users</p>
              <p id="maxUsers" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.can_create_branches">Can Create Branches</p>
              <p id="canCreateBranches" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.expiration_date">Expiration Date</p>
              <p id="expirationDate" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.created_at">Created At</p>
              <p id="createdAt" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.last_updated">Last Updated</p>
              <p id="updatedAt" class="text-white font-medium" style="color: #fff;"></p>
            </div>
          </div>
        </div>

        <!-- Wallet Overview -->
        <div class="glass-card p-6 mb-6">
          <div class="flex items-center justify-between mb-4" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 class="text-xl font-bold text-white" data-i18n-key="wallet.summary_title">Wallet Summary</h3>
            <span class="text-sm text-muted" id="institutionWalletUpdatedAt"></span>
          </div>
          <div id="institutionWalletSummary" class="grid grid-cols-3 gap-4" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <div class="loading-container"><div class="spinner"></div></div>
          </div>
          <div id="walletActionsContainer" class="wallet-actions" style="margin-top: 1.5rem; display: none;">
            <div class="grid grid-cols-3 gap-4" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
              <div>
                <label class="text-sm text-muted" data-i18n-key="wallet.original_amount">Original Amount</label>
                <input type="number" id="walletOriginalInput" min="0" step="0.01" class="form-input" placeholder="10000" />
              </div>
              <div>
                <label class="text-sm text-muted" data-i18n-key="wallet.profit_amount">Profit Amount</label>
                <input type="number" id="walletProfitInput" min="0" step="0.01" class="form-input" placeholder="1500" />
              </div>
              <div>
                <label class="text-sm text-muted" data-i18n-key="wallet.notes_placeholder">Optional note</label>
                <input type="text" id="walletNoteInput" class="form-input" placeholder="e.g. Quarterly funding" />
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
              <button id="fundWalletBtn" class="btn btn-primary" data-i18n-key="wallet.fund_wallet">Fund Wallet</button>
              <button id="defundWalletBtn" class="btn btn-warning" data-i18n-key="wallet.defund_wallet">Defund Wallet</button>
              <button id="adjustWalletBtn" class="btn btn-secondary" data-i18n-key="wallet.adjust_wallet">Manual Adjustment</button>
            </div>
            <div class="grid grid-cols-2 gap-4" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
              <div>
                <label class="text-sm text-muted" data-i18n-key="wallet.manual_original_delta">Manual Original Delta</label>
                <input type="number" id="manualOriginalInput" step="0.01" class="form-input" placeholder="5000 or -5000" />
              </div>
              <div>
                <label class="text-sm text-muted" data-i18n-key="wallet.manual_profit_delta">Manual Profit Delta</label>
                <input type="number" id="manualProfitInput" step="0.01" class="form-input" placeholder="250 or -250" />
              </div>
            </div>
          </div>
        </div>

        <!-- Wallet Transactions -->
        <div class="glass-card p-6 mb-6">
          <div class="flex items-center justify-between mb-4" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 class="text-xl font-bold text-white" data-i18n-key="wallet.transactions_title">Wallet Transactions</h3>
            <span class="text-sm text-muted" data-i18n-key="wallet.transactions_recent">Recent activity</span>
          </div>
          <div id="institutionWalletTransactions">
            <div class="loading-container"><div class="spinner"></div></div>
          </div>
        </div>
        
        <!-- Statistics -->
        <div class="glass-card p-6 mb-6">
          <h3 class="text-xl font-bold text-white mb-4" data-i18n-key="institutions.view_page.statistics">Statistics</h3>
          <div id="statsContainer">
            <div class="loading-container">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Branch Wallets -->
        <div class="glass-card p-6">
          <h3 class="text-xl font-bold text-white mb-4" data-i18n-key="institutions.view_page.branches">Branches</h3>
          <div id="branchesContainer">
            <div class="loading-container">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../components/sidebar.js"></script>
  <script src="../components/header.js"></script>
  <script>
    let currentUser = null;
    let canManageWallet = false;

    async function initPage() {
      await waitForI18n();
      
      if (!isAuthenticated()) {
        window.location.href = '../index.html';
        return;
      }
      
      currentUser = getCurrentUser();
      document.getElementById('sidebar').innerHTML = createSidebar(currentUser);
      document.getElementById('header').innerHTML = createHeader(
        t('institutions.institution_details'),
        t('institutions.view_institution_info')
      );
      initializeLanguageSwitcher();
      setActiveNav('institutions');
    }
    
    const loadingContainer = document.getElementById('loadingContainer');
    const institutionContainer = document.getElementById('institutionContainer');
    
    // Get institution ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const institutionId = urlParams.get('id');
    
    if (!institutionId) {
      window.location.href = 'institutions.html';
    }
    
    let institutionData = null;
    
    // Load institution data
    async function loadInstitution() {
      try {
        institutionData = await api.institutions.getById(institutionId);
        
        // Populate institution details
        document.getElementById('institutionName').textContent = institutionData.name;
        document.getElementById('institutionId').textContent = institutionData.institutionId;
        document.getElementById('taxId').textContent = institutionData.taxId || '--';
        document.getElementById('phoneNumber').textContent = institutionData.phoneNumber || '--';
        document.getElementById('email').textContent = institutionData.email || '--';
        document.getElementById('maxUsers').textContent = institutionData.maxUsers;
        document.getElementById('canCreateBranches').innerHTML = institutionData.canCreateBranches 
          ? `<span class="badge badge-success">‚úì ${t('institutions.view_page.yes')}</span>` 
          : `<span class="badge badge-danger">‚úó ${t('institutions.view_page.no')}</span>`;
        document.getElementById('expirationDate').textContent = institutionData.expirationDate ? formatDate(institutionData.expirationDate) : t('institutions.view_page.no_expiration');
        document.getElementById('createdAt').textContent = formatDateTime(institutionData.createdAt);
        document.getElementById('updatedAt').textContent = formatDateTime(institutionData.updatedAt);
        
        const statusBadge = document.getElementById('statusBadge');
        statusBadge.textContent = institutionData.isActive ? t('institutions.view_page.active') : t('institutions.view_page.inactive');
        statusBadge.className = `badge ${institutionData.isActive ? 'badge-success' : 'badge-danger'}`;
        
        document.getElementById('editBtn').href = `institutions-edit.html?id=${institutionId}`;
        
        loadingContainer.style.display = 'none';
        institutionContainer.style.display = 'block';
        
        canManageWallet = canManageInstitutionWallet(currentUser, institutionData.institutionId);
        toggleWalletActions();

        // Load wallet + dependent data
        loadInstitutionWallet();
        loadInstitutionWalletTransactions();
        loadStatistics();
        loadBranchWallets();
      } catch (error) {
        console.error('Error loading institution:', error);
        showToast('Failed to load institution', 'error');
        setTimeout(() => window.location.href = 'institutions.html', 2000);
      }
    }

    async function loadInstitutionWallet() {
      const summaryEl = document.getElementById('institutionWalletSummary');
      const updatedAtEl = document.getElementById('institutionWalletUpdatedAt');

      try {
        const response = await api.wallets.getInstitutionWallet(institutionId);
        const wallet = response?.wallet || {};

        if (updatedAtEl) {
          updatedAtEl.textContent = wallet.updatedAt
            ? `${t('wallet.last_updated')} ${formatDateTime(wallet.updatedAt)}`
            : '';
        }

        summaryEl.innerHTML = `
          <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
            <p class="text-sm text-muted">${t('wallet.original_balance')}</p>
            <p class="text-2xl font-bold text-white">${formatCurrency(wallet.originalBalance || 0)}</p>
          </div>
          <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
            <p class="text-sm text-muted">${t('wallet.profit_balance')}</p>
            <p class="text-2xl font-bold text-white">${formatCurrency(wallet.profitBalance || 0)}</p>
          </div>
          <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
            <p class="text-sm text-muted">${t('wallet.total_balance')}</p>
            <p class="text-2xl font-bold text-white">${formatCurrency(wallet.totalBalance || 0)}</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading institution wallet:', error);
        summaryEl.innerHTML = `<p class="text-muted">${t('wallet.failed_to_load')}</p>`;
      }
    }

    async function loadInstitutionWalletTransactions() {
      const container = document.getElementById('institutionWalletTransactions');
      try {
        const result = await api.walletTransactions.getInstitutionTransactions(institutionId, { limit: 8 });
        if (!result.data.length) {
          container.innerHTML = `<p class="text-muted">${t('wallet.transactions.empty')}</p>`;
          return;
        }

        const rows = result.data.map((tx) => `
          <tr>
            <td>${formatTransactionType(tx.transactionType)}</td>
            <td>${formatDeltaValue(tx.originalDelta)}</td>
            <td>${formatDeltaValue(tx.profitDelta)}</td>
            <td>${formatDeltaValue(tx.totalDelta)}</td>
            <td>${tx.description || '‚Äî'}</td>
            <td>${formatDateTime(tx.createdAt)}</td>
          </tr>
        `).join('');

        container.innerHTML = `
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>${t('wallet.transactions.type')}</th>
                  <th>${t('wallet.transactions.original')}</th>
                  <th>${t('wallet.transactions.profit')}</th>
                  <th>${t('wallet.transactions.total')}</th>
                  <th>${t('wallet.transactions.description')}</th>
                  <th>${t('wallet.transactions.created_at')}</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading wallet transactions:', error);
        container.innerHTML = `<p class="text-muted">${t('wallet.transactions.failed_to_load')}</p>`;
      }
    }
    
    async function loadStatistics() {
      try {
        const stats = await api.institutions.getStatistics(institutionId);
        const statsContainer = document.getElementById('statsContainer');
        
        statsContainer.innerHTML = `
          <div class="grid grid-cols-4 gap-4" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üè¢</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.total_branches">${t('institutions.view_page.total_branches')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.totalBranches || 0}</p>
            </div>
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üë•</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.active_users">${t('institutions.view_page.active_users')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.activeUsers || 0}</p>
            </div>
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üë§</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.total_customers">${t('institutions.view_page.total_customers')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.totalCustomers || 0}</p>
            </div>
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üí∞</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.total_loans">${t('institutions.view_page.total_loans')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.totalLoans || 0}</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('statsContainer').innerHTML = `<p class="text-muted" data-i18n-key="institutions.view_page.failed_to_load_statistics">${t('institutions.view_page.failed_to_load_statistics')}</p>`;
      }
    }
    
    async function loadBranchWallets() {
      const branchesContainer = document.getElementById('branchesContainer');
      try {
        const summaries = await api.wallets.getInstitutionBranchSummaries(institutionId);
        if (!summaries.length) {
          branchesContainer.innerHTML = `<p class="text-muted" data-i18n-key="institutions.view_page.no_branches_found">${t('institutions.view_page.no_branches_found')}</p>`;
          return;
        }

        const rows = summaries.map((summary) => `
          <tr>
            <td><a href="branches-view.html?id=${summary.branchId}" class="text-white underline">${summary.branchName}</a></td>
            <td>${formatCurrency(summary.wallet?.originalBalance || 0)}</td>
            <td>${formatCurrency(summary.wallet?.profitBalance || 0)}</td>
            <td>${formatCurrency(summary.wallet?.totalBalance || 0)}</td>
            <td><span class="badge ${summary.isActive ? 'badge-success' : 'badge-danger'}">${summary.isActive ? t('institutions.view_page.active') : t('institutions.view_page.inactive')}</span></td>
          </tr>
        `).join('');

        branchesContainer.innerHTML = `
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>${t('institutions.view_page.branch_name')}</th>
                  <th>${t('wallet.original_balance')}</th>
                  <th>${t('wallet.profit_balance')}</th>
                  <th>${t('wallet.total_balance')}</th>
                  <th>${t('institutions.view_page.status')}</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading branch wallets:', error);
        branchesContainer.innerHTML = `<p class="text-muted" data-i18n-key="institutions.view_page.failed_to_load_branches">${t('institutions.view_page.failed_to_load_branches')}</p>`;
      }
    }

    function formatTransactionType(txType) {
      if (!txType) return t('wallet.transaction_types.manual_adjustment');
      const key = `wallet.transaction_types.${txType}`;
      return t(key) || txType;
    }

    function formatDeltaValue(value) {
      const numeric = Number(value || 0);
      const formatted = formatCurrency(Math.abs(numeric));
      const prefix = numeric >= 0 ? '+' : '-';
      return `<span class="${numeric >= 0 ? 'text-success' : 'text-danger'}">${prefix} ${formatted}</span>`;
    }

    function toggleWalletActions() {
      const actions = document.getElementById('walletActionsContainer');
      if (!actions) return;
      actions.style.display = canManageWallet ? 'block' : 'none';
    }

    async function handleFundWallet() {
      if (!canManageWallet) return;
      const payload = buildManagePayload();
      if (!payload) return;

      try {
        await api.wallets.fundInstitution(institutionId, payload);
        showToast(t('wallet.fund_success') || 'Wallet funded', 'success');
        resetWalletInputs();
        loadInstitutionWallet();
        loadInstitutionWalletTransactions();
      } catch (error) {
        console.error('Error funding wallet:', error);
        showToast(error.message || 'Failed to fund wallet', 'error');
      }
    }

    async function handleDefundWallet() {
      if (!canManageWallet) return;
      const payload = buildManagePayload();
      if (!payload) return;

      try {
        await api.wallets.defundInstitution(institutionId, payload);
        showToast(t('wallet.defund_success') || 'Wallet defunded', 'success');
        resetWalletInputs();
        loadInstitutionWallet();
        loadInstitutionWalletTransactions();
      } catch (error) {
        console.error('Error defunding wallet:', error);
        showToast(error.message || 'Failed to defund wallet', 'error');
      }
    }

    async function handleManualAdjust() {
      if (!canManageWallet) return;
      const manualOriginal = parseFloat(document.getElementById('manualOriginalInput').value || '0');
      const manualProfit = parseFloat(document.getElementById('manualProfitInput').value || '0');
      if (manualOriginal === 0 && manualProfit === 0) {
        showToast(t('wallet.provide_amount'), 'error');
        return;
      }

      try {
        await api.wallets.adjustInstitution(institutionId, {
          originalDelta: manualOriginal,
          profitDelta: manualProfit,
          note: getWalletNote(),
        });
        showToast(t('wallet.adjust_success') || 'Wallet adjusted', 'success');
        resetWalletInputs();
        document.getElementById('manualOriginalInput').value = '';
        document.getElementById('manualProfitInput').value = '';
        loadInstitutionWallet();
        loadInstitutionWalletTransactions();
      } catch (error) {
        console.error('Error adjusting wallet:', error);
        showToast(error.message || 'Failed to adjust wallet', 'error');
      }
    }

    function buildManagePayload() {
      const originalInput = document.getElementById('walletOriginalInput');
      const profitInput = document.getElementById('walletProfitInput');
      const originalAmount = parseFloat(originalInput.value || '0');
      const profitAmount = parseFloat(profitInput.value || '0');
      if (originalAmount <= 0 && profitAmount <= 0) {
        showToast(t('wallet.provide_amount'), 'error');
        return null;
      }
      return {
        originalAmount,
        profitAmount,
        note: getWalletNote(),
      };
    }

    function resetWalletInputs() {
      document.getElementById('walletOriginalInput').value = '';
      document.getElementById('walletProfitInput').value = '';
      document.getElementById('walletNoteInput').value = '';
    }

    function getWalletNote() {
      const noteInput = document.getElementById('walletNoteInput');
      return noteInput ? noteInput.value : undefined;
    }

    function canManageInstitutionWallet(user, targetInstitutionId) {
      if (!user) return false;
      const roleName = typeof user.role === 'string' ? user.role : user.role?.roleName;
      if (roleName === 'Super Admin') return true;
      if (roleName === 'Institution' && user.institutionId === targetInstitutionId) return true;
      return false;
    }
    
    // Delete institution
    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (!confirm(t('institutions.view_page.delete_confirmation'))) return;
      
      try {
        await api.institutions.delete(institutionId);
        showToast('Institution deleted successfully', 'success');
        window.location.href = 'institutions.html';
      } catch (error) {
        console.error('Error deleting institution:', error);
        showToast(error.message || 'Failed to delete institution', 'error');
      }
    });
    
    document.getElementById('fundWalletBtn')?.addEventListener('click', handleFundWallet);
    document.getElementById('defundWalletBtn')?.addEventListener('click', handleDefundWallet);
    document.getElementById('adjustWalletBtn')?.addEventListener('click', handleManualAdjust);

    loadInstitution();
  </script>
</body>
</html>
