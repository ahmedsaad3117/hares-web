<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Institution Details - Hares Platform</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div id="sidebar"></div>
  
  <div class="main-content">
    <div id="header"></div>
    
    <div class="page-content">
      <!-- Page Header -->
      <div class="flex items-center gap-3 mb-8" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
        <a href="institutions.html" class="btn btn-secondary" style="padding: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-white">Institution Details</h1>
          <p class="text-secondary">View institution information</p>
        </div>
      </div>
      
      <!-- Loading -->
      <div id="loadingContainer" class="loading-container">
        <div class="spinner"></div>
      </div>
      
      <!-- Institution Details -->
      <div id="institutionContainer" style="display: none;">
        <div class="glass-card p-6 mb-6">
          <div class="flex items-center justify-between mb-6" style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1.5rem;">
            <div>
              <h2 id="institutionName" class="text-2xl font-bold text-white mb-2"></h2>
              <p class="text-muted">Institution ID: <span id="institutionId"></span></p>
            </div>
            <div class="flex gap-2" style="display: flex; gap: 0.5rem;">
              <span id="statusBadge" class="badge"></span>
              <a id="editBtn" class="btn btn-primary">Edit</a>
              <button id="deleteBtn" class="btn btn-danger">Delete</button>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-6" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
            <div>
              <p class="text-muted mb-1">Max Users</p>
              <p id="maxUsers" class="text-white font-medium"></p>
            </div>
            <div>
              <p class="text-muted mb-1">Created At</p>
              <p id="createdAt" class="text-white font-medium"></p>
            </div>
            <div>
              <p class="text-muted mb-1">Last Updated</p>
              <p id="updatedAt" class="text-white font-medium"></p>
            </div>
          </div>
        </div>
        
        <!-- Statistics -->
        <div class="glass-card p-6 mb-6">
          <h3 class="text-xl font-bold text-white mb-4">Statistics</h3>
          <div id="statsContainer">
            <div class="loading-container">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Branches -->
        <div class="glass-card p-6">
          <h3 class="text-xl font-bold text-white mb-4">Branches</h3>
          <div id="branchesContainer">
            <div class="loading-container">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../components/sidebar.js"></script>
  <script src="../components/header.js"></script>
  <script>
    // Check authentication
    if (!isAuthenticated()) {
      window.location.href = '../index.html';
    }
    
    const user = getCurrentUser();
    document.getElementById('sidebar').innerHTML = createSidebar(user);
    document.getElementById('header').innerHTML = createHeader('Institution Details', 'View institution information');
    setActiveNav('institutions');
    
    const loadingContainer = document.getElementById('loadingContainer');
    const institutionContainer = document.getElementById('institutionContainer');
    
    // Get institution ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const institutionId = urlParams.get('id');
    
    if (!institutionId) {
      window.location.href = 'institutions.html';
    }
    
    let institutionData = null;
    
    // Load institution data
    async function loadInstitution() {
      try {
        institutionData = await api.institutions.getById(institutionId);
        
        // Populate institution details
        document.getElementById('institutionName').textContent = institutionData.name;
        document.getElementById('institutionId').textContent = institutionData.institutionId;
        document.getElementById('maxUsers').textContent = institutionData.maxUsers;
        document.getElementById('createdAt').textContent = formatDateTime(institutionData.createdAt);
        document.getElementById('updatedAt').textContent = formatDateTime(institutionData.updatedAt);
        
        const statusBadge = document.getElementById('statusBadge');
        statusBadge.textContent = institutionData.isActive ? 'Active' : 'Inactive';
        statusBadge.className = `badge ${institutionData.isActive ? 'badge-success' : 'badge-danger'}`;
        
        document.getElementById('editBtn').href = `institutions-edit.html?id=${institutionId}`;
        
        loadingContainer.style.display = 'none';
        institutionContainer.style.display = 'block';
        
        // Load statistics and branches
        loadStatistics();
        loadBranches();
      } catch (error) {
        console.error('Error loading institution:', error);
        showToast('Failed to load institution', 'error');
        setTimeout(() => window.location.href = 'institutions.html', 2000);
      }
    }
    
    async function loadStatistics() {
      try {
        const stats = await api.institutions.getStatistics(institutionId);
        const statsContainer = document.getElementById('statsContainer');
        
        statsContainer.innerHTML = `
          <div class="grid grid-cols-4 gap-4" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
              <p class="text-muted text-sm">Total Branches</p>
              <p class="text-2xl font-bold text-white">${stats.totalBranches || 0}</p>
            </div>
            <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
              <p class="text-muted text-sm">Active Users</p>
              <p class="text-2xl font-bold text-white">${stats.activeUsers || 0}</p>
            </div>
            <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
              <p class="text-muted text-sm">Total Customers</p>
              <p class="text-2xl font-bold text-white">${stats.totalCustomers || 0}</p>
            </div>
            <div class="glass-card p-4" style="background: rgba(30, 41, 59, 0.5);">
              <p class="text-muted text-sm">Total Loans</p>
              <p class="text-2xl font-bold text-white">${stats.totalLoans || 0}</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('statsContainer').innerHTML = '<p class="text-muted">Failed to load statistics</p>';
      }
    }
    
    async function loadBranches() {
      try {
        const branches = await api.branches.getAll(institutionId);
        const branchesContainer = document.getElementById('branchesContainer');
        
        if (branches.length === 0) {
          branchesContainer.innerHTML = '<p class="text-muted">No branches found for this institution</p>';
          return;
        }
        
        const branchesHTML = branches.map(branch => `
          <div class="glass-card p-4 mb-3" style="background: rgba(30, 41, 59, 0.5);">
            <div class="flex items-center justify-between" style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <p class="text-white font-medium">${branch.name}</p>
                <p class="text-sm text-muted">Branch #${branch.branchId}</p>
              </div>
              <span class="badge ${branch.isActive ? 'badge-success' : 'badge-danger'}">${branch.isActive ? 'Active' : 'Inactive'}</span>
            </div>
          </div>
        `).join('');
        
        branchesContainer.innerHTML = branchesHTML;
      } catch (error) {
        console.error('Error loading branches:', error);
        document.getElementById('branchesContainer').innerHTML = '<p class="text-muted">Failed to load branches</p>';
      }
    }
    
    // Delete institution
    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this institution? This will also delete all associated branches and users.')) return;
      
      try {
        await api.institutions.delete(institutionId);
        showToast('Institution deleted successfully', 'success');
        window.location.href = 'institutions.html';
      } catch (error) {
        console.error('Error deleting institution:', error);
        showToast(error.message || 'Failed to delete institution', 'error');
      }
    });
    
    loadInstitution();
  </script>
</body>
</html>
