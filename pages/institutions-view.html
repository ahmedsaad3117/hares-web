<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Institution Details - Q1KEY Platform</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/i18n.js"></script>
</head>
<body>
  <div id="sidebar"></div>
  
  <div class="main-content">
    <div id="header"></div>
    
    <div class="page-content">
      <!-- Page Header -->
      <div class="flex items-center gap-3 mb-8" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
        <a href="institutions.html" class="btn btn-secondary" style="padding: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-white" data-i18n-key="institutions.view_institution">Institution Details</h1>
          <p class="text-secondary" data-i18n-key="institutions.view_institution_info">View institution information</p>
        </div>
      </div>
      
      <!-- Loading -->
      <div id="loadingContainer" class="loading-container">
        <div class="spinner"></div>
      </div>
      
      <!-- Institution Details -->
      <div id="institutionContainer" style="display: none;">
        <div class="glass-card p-6 mb-6">
          <div class="flex items-center justify-between mb-6" style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1.5rem;">
            <div>
              <h2 id="institutionName" class="text-2xl font-bold text-white mb-2"></h2>
              <p class="text-muted"><span data-i18n-key="institutions.view_page.institution_id">Institution ID</span>: <span id="institutionId"></span></p>
            </div>
            <div class="flex gap-2" style="display: flex; gap: 0.5rem;">
              <span id="statusBadge" class="badge"></span>
              <a id="editBtn" class="btn btn-primary" data-i18n-key="common.button.edit">Edit</a>
              <button id="deleteBtn" class="btn btn-danger" data-i18n-key="common.button.delete">Delete</button>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-6" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.tax_id">Tax ID</p>
              <p id="taxId" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.phone_number">Phone Number</p>
              <p id="phoneNumber" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.email">Email</p>
              <p id="email" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.max_users">Max Users</p>
              <p id="maxUsers" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.can_create_branches">Can Create Branches</p>
              <p id="canCreateBranches" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.expiration_date">Expiration Date</p>
              <p id="expirationDate" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.created_at">Created At</p>
              <p id="createdAt" class="text-white font-medium" style="color: #fff;"></p>
            </div>
            <div>
              <p class="text-muted mb-1" data-i18n-key="institutions.view_page.last_updated">Last Updated</p>
              <p id="updatedAt" class="text-white font-medium" style="color: #fff;"></p>
            </div>
          </div>
        </div>
        
        <!-- Statistics -->
        <div class="glass-card p-6 mb-6">
          <h3 class="text-xl font-bold text-white mb-4" data-i18n-key="institutions.view_page.statistics">Statistics</h3>
          <div id="statsContainer">
            <div class="loading-container">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Branches -->
        <div class="glass-card p-6">
          <h3 class="text-xl font-bold text-white mb-4" data-i18n-key="institutions.view_page.branches">Branches</h3>
          <div id="branchesContainer">
            <div class="loading-container">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../components/sidebar.js"></script>
  <script src="../components/header.js"></script>
  <script>
    async function initPage() {
      await waitForI18n();
      
      if (!isAuthenticated()) {
        window.location.href = '../index.html';
        return;
      }
      
      const user = getCurrentUser();
      document.getElementById('sidebar').innerHTML = createSidebar(user);
      document.getElementById('header').innerHTML = createHeader(
        t('institutions.institution_details'),
        t('institutions.view_institution_info')
      );
      initializeLanguageSwitcher();
      setActiveNav('institutions');
    }
    
    const loadingContainer = document.getElementById('loadingContainer');
    const institutionContainer = document.getElementById('institutionContainer');
    
    // Get institution ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const institutionId = urlParams.get('id');
    
    if (!institutionId) {
      window.location.href = 'institutions.html';
    }
    
    let institutionData = null;
    
    // Load institution data
    async function loadInstitution() {
      try {
        institutionData = await api.institutions.getById(institutionId);
        
        // Populate institution details
        document.getElementById('institutionName').textContent = institutionData.name;
        document.getElementById('institutionId').textContent = institutionData.institutionId;
        document.getElementById('taxId').textContent = institutionData.taxId || '--';
        document.getElementById('phoneNumber').textContent = institutionData.phoneNumber || '--';
        document.getElementById('email').textContent = institutionData.email || '--';
        document.getElementById('maxUsers').textContent = institutionData.maxUsers;
        document.getElementById('canCreateBranches').innerHTML = institutionData.canCreateBranches 
          ? `<span class="badge badge-success">‚úì ${t('institutions.view_page.yes')}</span>` 
          : `<span class="badge badge-danger">‚úó ${t('institutions.view_page.no')}</span>`;
        document.getElementById('expirationDate').textContent = institutionData.expirationDate ? formatDate(institutionData.expirationDate) : t('institutions.view_page.no_expiration');
        document.getElementById('createdAt').textContent = formatDateTime(institutionData.createdAt);
        document.getElementById('updatedAt').textContent = formatDateTime(institutionData.updatedAt);
        
        const statusBadge = document.getElementById('statusBadge');
        statusBadge.textContent = institutionData.isActive ? t('institutions.view_page.active') : t('institutions.view_page.inactive');
        statusBadge.className = `badge ${institutionData.isActive ? 'badge-success' : 'badge-danger'}`;
        
        document.getElementById('editBtn').href = `institutions-edit.html?id=${institutionId}`;
        
        loadingContainer.style.display = 'none';
        institutionContainer.style.display = 'block';
        
        // Load statistics and branches
        loadStatistics();
        loadBranches();
      } catch (error) {
        console.error('Error loading institution:', error);
        showToast('Failed to load institution', 'error');
        setTimeout(() => window.location.href = 'institutions.html', 2000);
      }
    }
    
    async function loadStatistics() {
      try {
        const stats = await api.institutions.getStatistics(institutionId);
        const statsContainer = document.getElementById('statsContainer');
        
        statsContainer.innerHTML = `
          <div class="grid grid-cols-4 gap-4" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üè¢</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.total_branches">${t('institutions.view_page.total_branches')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.totalBranches || 0}</p>
            </div>
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üë•</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.active_users">${t('institutions.view_page.active_users')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.activeUsers || 0}</p>
            </div>
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üë§</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.total_customers">${t('institutions.view_page.total_customers')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.totalCustomers || 0}</p>
            </div>
            <div style="padding: 1.5rem; border-radius: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 1.5rem;">üí∞</div>
                <p class="text-muted text-sm" data-i18n-key="institutions.view_page.total_loans">${t('institutions.view_page.total_loans')}</p>
              </div>
              <p class="text-2xl font-bold text-white" style="color: #fff;">${stats.totalLoans || 0}</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('statsContainer').innerHTML = `<p class="text-muted" data-i18n-key="institutions.view_page.failed_to_load_statistics">${t('institutions.view_page.failed_to_load_statistics')}</p>`;
      }
    }
    
    async function loadBranches() {
      try {
        const branches = await api.branches.getAll(institutionId);
        const branchesContainer = document.getElementById('branchesContainer');
        
        if (branches.length === 0) {
          branchesContainer.innerHTML = `<p class="text-muted" data-i18n-key="institutions.view_page.no_branches_found">${t('institutions.view_page.no_branches_found')}</p>`;
          return;
        }
        
        const branchesHTML = branches.map(branch => `
          <div style="padding: 1rem; border-radius: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 0.75rem;">
            <div class="flex items-center justify-between" style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <a href="branches-view.html?id=${branch.branchId}" class="text-white font-medium" style="color: #fff; text-decoration: underline; font-size: 1rem;">${branch.name}</a>
                <p class="text-sm text-muted" style="margin-top: 0.25rem;"><span data-i18n-key="institutions.view_page.branch_id">${t('institutions.view_page.branch_id')}</span>: #${branch.branchId}</p>
              </div>
              <span class="badge ${branch.isActive ? 'badge-success' : 'badge-danger'}">${branch.isActive ? t('institutions.view_page.active') : t('institutions.view_page.inactive')}</span>
            </div>
          </div>
        `).join('');
        
        branchesContainer.innerHTML = branchesHTML;
      } catch (error) {
        console.error('Error loading branches:', error);
        document.getElementById('branchesContainer').innerHTML = `<p class="text-muted" data-i18n-key="institutions.view_page.failed_to_load_branches">${t('institutions.view_page.failed_to_load_branches')}</p>`;
      }
    }
    
    // Delete institution
    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (!confirm(t('institutions.view_page.delete_confirmation'))) return;
      
      try {
        await api.institutions.delete(institutionId);
        showToast('Institution deleted successfully', 'success');
        window.location.href = 'institutions.html';
      } catch (error) {
        console.error('Error deleting institution:', error);
        showToast(error.message || 'Failed to delete institution', 'error');
      }
    });
    
    loadInstitution();
  </script>
</body>
</html>
