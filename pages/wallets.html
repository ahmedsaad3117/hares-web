<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet Center - Q1KEY Platform</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/i18n.js"></script>
</head>
<body>
  <div id="sidebar"></div>
  <div class="main-content">
    <div id="header"></div>
    <div class="page-content">
      <div id="walletContent" class="space-y-6">
        <div class="loading-container"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../components/sidebar.js"></script>
  <script src="../components/header.js"></script>
  <script>
    let currentUser = null;
    let walletContent = null;
    let allWalletsData = [];
    let currentView = null;
    const transactionFilters = {
      branch: { fromDate: '', toDate: '' },
      institution: { fromDate: '', toDate: '' },
    };
    const transactionTotals = {
      branch: null,
      institution: null,
    };
    let branchWalletSnapshot = null;
    let institutionWalletSnapshot = null;

    const TRANSACTION_DESCRIPTION_PATTERNS = [
      { regex: /loan\s+#?(\d+)\s+disbursement/i, transform: (match) => `صرف قرض رقم ${match[1]}` },
      { regex: /loan\s+#?(\d+)\s+repayment/i, transform: (match) => `سداد قرض رقم ${match[1]}` },
      { regex: /installment\s+#?(\d+)\s+payment/i, transform: (match) => `سداد قسط رقم ${match[1]}` },
      { regex: /manual\s+adjustment/i, transform: () => 'تعديل يدوي' },
      { regex: /wallet\s+transfer/i, transform: () => 'تحويل المحفظة' },
    ];

    const TRANSACTION_DESCRIPTION_DICTIONARY = {
      loan: 'قرض',
      installment: 'قسط',
      payment: 'دفعة',
      disbursement: 'صرف',
      transfer: 'تحويل',
      branch: 'فرع',
      institution: 'مؤسسة',
      wallet: 'محفظة',
      manual: 'يدوي',
      adjustment: 'تعديل',
      refund: 'استرداد',
      deposit: 'إيداع',
    };

    function createTransactionFilterBlock(context) {
      const scope = context === 'institution' ? 'institution' : 'branch';
      const filters = transactionFilters[scope] || {};
      const applyHandler = scope === 'institution' ? 'applyInstitutionTransactionFilters' : 'applyBranchTransactionFilters';
      const resetHandler = scope === 'institution' ? 'resetInstitutionTransactionFilters' : 'resetBranchTransactionFilters';

      return `
        <div class="transactions-filter-card">
          <div id="${scope}-filter-summary">
            ${renderFilterSummary(scope)}
          </div>
          <div class="transactions-filter-panel">
            <div class="filter-field">
              <label class="text-sm text-muted" for="${scope}FromDate">${t('wallet.transactions.from_date')}</label>
              <div class="input-affix">
                ${renderCalendarIcon()}
                <input type="date" id="${scope}FromDate" class="input filter-input" value="${filters.fromDate || ''}">
              </div>
            </div>
            <div class="filter-field">
              <label class="text-sm text-muted" for="${scope}ToDate">${t('wallet.transactions.to_date')}</label>
              <div class="input-affix">
                ${renderCalendarIcon()}
                <input type="date" id="${scope}ToDate" class="input filter-input" value="${filters.toDate || ''}">
              </div>
            </div>
            <div class="filter-actions">
              <button class="btn btn-secondary" onclick="${resetHandler}()">${t('wallet.transactions.reset_filters')}</button>
              <button class="btn btn-primary" onclick="${applyHandler}()">${t('wallet.transactions.apply_filters')}</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderFilterSummary(context) {
      const scope = context === 'institution' ? 'institution' : 'branch';
      const filters = transactionFilters[scope] || {};
      const chips = [];

      if (filters.fromDate) {
        chips.push(`
          <span class="transactions-filter-chip">
            <span class="chip-label">${t('wallet.transactions.from_chip_label')}</span>
            ${formatFilterDate(filters.fromDate)}
          </span>
        `);
      }

      if (filters.toDate) {
        chips.push(`
          <span class="transactions-filter-chip">
            <span class="chip-label">${t('wallet.transactions.to_chip_label')}</span>
            ${formatFilterDate(filters.toDate)}
          </span>
        `);
      }

      const hasFilters = chips.length > 0;
      const summaryText = hasFilters
        ? t('wallet.transactions.filter_summary_active')
        : t('wallet.transactions.filter_summary_default');
      const chipMarkup = hasFilters
        ? chips.join('')
        : `<span class="transactions-filter-chip chip-muted">${t('wallet.transactions.filter_summary_none_chip')}</span>`;

      return `
        <div class="transactions-filter-summary">
          <div>
            <p class="summary-title">${t('wallet.transactions.filter_panel_title')}</p>
            <p class="summary-description">${summaryText}</p>
          </div>
          <div class="transactions-filter-chips">
            ${chipMarkup}
          </div>
        </div>
      `;
    }

    function updateTransactionFilterSummary(context) {
      const scope = context === 'institution' ? 'institution' : 'branch';
      const target = document.getElementById(`${scope}-filter-summary`);
      if (target) {
        target.innerHTML = renderFilterSummary(scope);
      }
    }

    function renderCalendarIcon() {
      return `
        <span class="affix-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </span>
      `;
    }

    function formatFilterDate(value) {
      if (!value) return '—';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return value;
      }
      const locale = window.i18n?.getCurrentLocale?.() === 'ar' ? 'ar-EG' : 'en-GB';
      return date.toLocaleDateString(locale, { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function renderFundingShortcut() {
      if (!currentUser || !['Super Admin', 'Institution'].includes(currentUser.roleName)) {
        return '';
      }

      return `
        <div class="glass-card p-4 mb-6" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; background: rgba(15,23,42,0.7);">
          <div>
            <p class="text-sm text-muted uppercase tracking-wide">${t('wallet.fund_shortcut_title')}</p>
            <p class="text-white text-lg font-semibold">${t('wallet.fund_shortcut_description')}</p>
          </div>
          <a href="wallet-fund.html" class="btn btn-primary">${t('wallet.fund_shortcut_cta')}</a>
        </div>
      `;
    }

    window.addEventListener('localeChanged', () => {
      if (!currentUser || !currentView) return;
      if (currentView === 'branch') {
        renderBranchView();
      } else if (currentView === 'institution') {
        renderInstitutionView();
      } else if (currentView === 'superAdmin') {
        renderSuperAdminView();
      }
    });

    async function initPage() {
      await waitForI18n();

      if (!isAuthenticated()) {
        window.location.href = '../index.html';
        return;
      }

      currentUser = getCurrentUser();
      walletContent = document.getElementById('walletContent');

      document.getElementById('sidebar').innerHTML = createSidebar(currentUser);
      document.getElementById('header').innerHTML = createHeader(
        t('wallet.center_title'),
        t('wallet.center_subtitle')
      );
      initializeLanguageSwitcher();
      setActiveNav('wallets');
      window.i18n.translatePage();

      if (currentUser.roleName === 'Branch') {
        renderBranchView();
      } else if (currentUser.roleName === 'Institution') {
        renderInstitutionView();
      } else {
        renderSuperAdminView();
      }
    }

    function renderLoadingState(message) {
      walletContent.innerHTML = `
        <div class="glass-card p-6">
          <div class="loading-container" style="min-height: 120px;">
            <div class="spinner"></div>
            ${message ? `<p class="text-muted mt-4">${message}</p>` : ''}
          </div>
        </div>
      `;
    }

    function renderMessageCard(text, tone = 'info') {
      const toneColor = tone === 'error' ? 'rgba(239,68,68,0.15)' : 'rgba(59,130,246,0.12)';
      walletContent.innerHTML = `
        <div class="glass-card p-6" style="background: ${toneColor}; border: 1px solid rgba(255,255,255,0.08);">
          <p class="text-white">${text}</p>
        </div>
      `;
    }

    async function renderBranchView() {
      currentView = 'branch';
      if (!currentUser.branchId) {
        renderMessageCard(t('wallet.missing_branch_message'), 'error');
        return;
      }

      renderLoadingState();
      try {
        const response = await api.wallets.getBranchWallet(currentUser.branchId);
        const { branch, wallet } = response;
        const shortcut = renderFundingShortcut();

        walletContent.innerHTML = `
          ${shortcut}
          <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
              <div>
                <p class="text-sm text-muted uppercase tracking-wide">${t('wallet.branch_section_title')}</p>
                <h2 class="text-2xl font-bold text-white">${branch?.name || '—'}</h2>
                <p class="text-muted">${branch?.institutionName || ''}</p>
              </div>
              <div class="flex items-center gap-2" style="display:flex; align-items:center; gap:0.5rem;">
                <span class="badge">${t('wallet.owner_types.branch')}</span>
                <span class="badge badge-info" id="branch-summary-filter" style="display:none;">${t('wallet.filter_active_badge')}</span>
              </div>
            </div>
            <p class="text-xs text-muted" id="branch-summary-note" style="min-height:16px; margin-bottom:0.5rem;"></p>
            ${createSummaryGrid(wallet, 'branch')}
          </div>

          <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-4" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
              <h3 class="text-xl font-bold text-white">${t('wallet.transactions_title')}</h3>
              <span class="text-muted text-sm">${t('wallet.transactions_recent')}</span>
            </div>
            ${createTransactionFilterBlock('branch')}
            <div id="branchTransactions" class="table-responsive">
              <div class="loading-container"><div class="spinner"></div></div>
            </div>
          </div>
        `;

        branchWalletSnapshot = wallet;
        updateSummaryDelta('branch', null, false);
        const branchTotals = await loadBranchTransactions(currentUser.branchId);
        const branchFilterActive = isBranchFilterActive();
        transactionTotals.branch = branchFilterActive ? branchTotals : null;
        updateSummaryDelta('branch', transactionTotals.branch, branchFilterActive);
      } catch (error) {
        console.error('Failed to load branch wallet', error);
        renderMessageCard(t('wallet.failed_to_load'), 'error');
      }
    }

    async function loadBranchTransactions(branchId) {
      const container = document.getElementById('branchTransactions');
      if (!container) return;
      container.innerHTML = `<div class="loading-container"><div class="spinner"></div></div>`;

      try {
        const params = { limit: 10 };
        const { fromDate, toDate } = transactionFilters.branch;
        if (fromDate) params.fromDate = fromDate;
        if (toDate) params.toDate = toDate;
        const result = await api.walletTransactions.getBranchTransactions(branchId, params);
        const transactions = result?.data || [];
        const totals = calculateTransactionTotals(transactions);
        container.innerHTML = renderTransactionsTable(transactions, totals);
        return totals;
      } catch (error) {
        console.error('Failed to load branch transactions', error);
        container.innerHTML = `<p class="text-muted">${t('wallet.transactions.failed_to_load')}</p>`;
        return null;
      }
    }

    async function applyBranchTransactionFilters() {
      const fromInput = document.getElementById('branchFromDate');
      const toInput = document.getElementById('branchToDate');
      transactionFilters.branch.fromDate = fromInput?.value || '';
      transactionFilters.branch.toDate = toInput?.value || '';
      if (currentUser?.branchId) {
        const totals = await loadBranchTransactions(currentUser.branchId);
        const active = isBranchFilterActive();
        transactionTotals.branch = active ? totals : null;
        updateSummaryDelta('branch', transactionTotals.branch, active);
      }
      updateTransactionFilterSummary('branch');
    }

    async function resetBranchTransactionFilters() {
      const fromInput = document.getElementById('branchFromDate');
      const toInput = document.getElementById('branchToDate');
      if (fromInput) fromInput.value = '';
      if (toInput) toInput.value = '';
      transactionFilters.branch.fromDate = '';
      transactionFilters.branch.toDate = '';
      if (currentUser?.branchId) {
        await loadBranchTransactions(currentUser.branchId);
      }
      transactionTotals.branch = null;
      updateSummaryDelta('branch', null, false);
      updateTransactionFilterSummary('branch');
    }

    async function renderInstitutionView() {
      currentView = 'institution';
      if (!currentUser.institutionId) {
        renderMessageCard(t('wallet.missing_institution_message'), 'error');
        return;
      }

      renderLoadingState();
      try {
        const [walletResponse, branchSummaries] = await Promise.all([
          api.wallets.getInstitutionWallet(currentUser.institutionId),
          currentUser.canCreateBranches === false
            ? Promise.resolve([])
            : api.wallets.getInstitutionBranchSummaries(currentUser.institutionId),
        ]);
        const wallet = walletResponse?.wallet;
        const shortcut = renderFundingShortcut();

        let branchSectionHtml = '';
        if (currentUser.canCreateBranches === false) {
          branchSectionHtml = `
            <div class="glass-card p-6" style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2);">
              <p class="text-sm text-white">${t('wallet.limited_institution_message')}</p>
            </div>
          `;
        } else {
          branchSectionHtml = `
            <div class="glass-card p-6">
              <div class="flex items-center justify-between mb-4" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
                <h3 class="text-xl font-bold text-white">${t('institutions.view_page.branches')}</h3>
                <span class="text-muted text-sm">${branchSummaries.length || 0} ${t('institutions.view_page.branches')}</span>
              </div>
              <div id="institutionBranchWallets"></div>
            </div>
          `;
        }

        walletContent.innerHTML = `
          ${shortcut}
          <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
              <div>
                <p class="text-sm text-muted uppercase tracking-wide">${t('wallet.institution_section_title')}</p>
                <h2 class="text-2xl font-bold text-white">${walletResponse?.institutionName || t('wallet.owner_types.institution')}</h2>
              </div>
              <div class="flex items-center gap-2" style="display:flex; align-items:center; gap:0.5rem;">
                <span class="badge">${t('wallet.owner_types.institution')}</span>
                <span class="badge badge-info" id="institution-summary-filter" style="display:none;">${t('wallet.filter_active_badge')}</span>
              </div>
            </div>
            <p class="text-xs text-muted" id="institution-summary-note" style="min-height:16px; margin-bottom:0.5rem;"></p>
            ${createSummaryGrid(wallet, 'institution')}
          </div>

          <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
              <h3 class="text-xl font-bold text-white">${t('wallet.transactions_title')}</h3>
              <span class="text-muted text-sm">${t('wallet.transactions_recent')}</span>
            </div>
            ${createTransactionFilterBlock('institution')}
            <div id="institutionTransactions" class="table-responsive">
              <div class="loading-container"><div class="spinner"></div></div>
            </div>
          </div>

          ${branchSectionHtml}
        `;

        if (currentUser.canCreateBranches !== false) {
          renderBranchSummaries(branchSummaries);
        }

        institutionWalletSnapshot = wallet;
        updateSummaryDelta('institution', null, false);
        const institutionTotals = await loadInstitutionTransactions(currentUser.institutionId);
        const institutionFilterActive = isInstitutionFilterActive();
        transactionTotals.institution = institutionFilterActive ? institutionTotals : null;
        updateSummaryDelta('institution', transactionTotals.institution, institutionFilterActive);
      } catch (error) {
        console.error('Failed to load institution wallet', error);
        renderMessageCard(t('wallet.failed_to_load'), 'error');
      }
    }

    function renderBranchSummaries(summaries = []) {
      const container = document.getElementById('institutionBranchWallets');
      if (!container) return;

      if (!summaries.length) {
        container.innerHTML = `<p class="text-muted">${t('institutions.view_page.no_branches_found')}</p>`;
        return;
      }

      const rows = summaries.map((summary) => {
        const expectedProfit = summary.wallet?.expectedProfitBalance ?? summary.wallet?.profitBalance ?? 0;
        const currentProfit = summary.wallet?.profitBalance ?? 0;
        return `
          <tr>
            <td><a href="branches-view.html?id=${summary.branchId}" class="text-white underline">${summary.branchName}</a></td>
            <td>${formatCurrency(summary.wallet?.originalBalance || 0)}</td>
            <td>${formatCurrency(currentProfit)}</td>
            <td>${formatCurrency(expectedProfit)}</td>
            <td>${formatCurrency(summary.wallet?.totalBalance || 0)}</td>
            <td>
              <span class="badge ${summary.isActive ? 'badge-success' : 'badge-danger'}">
                ${summary.isActive ? t('institutions.view_page.active') : t('institutions.view_page.inactive')}
              </span>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>${t('institutions.view_page.branch_name')}</th>
                <th>${t('wallet.original_balance')}</th>
                <th>${t('wallet.current_profit_balance')}</th>
                <th>${t('wallet.expected_profit_balance')}</th>
                <th>${t('wallet.total_balance')}</th>
                <th>${t('institutions.view_page.status')}</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    async function loadInstitutionTransactions(institutionId) {
      const container = document.getElementById('institutionTransactions');
      if (!container) return;
      container.innerHTML = `<div class="loading-container"><div class="spinner"></div></div>`;

      try {
        const params = { limit: 12 };
        const { fromDate, toDate } = transactionFilters.institution;
        if (fromDate) params.fromDate = fromDate;
        if (toDate) params.toDate = toDate;
        const result = await api.walletTransactions.getInstitutionTransactions(institutionId, params);
        const transactions = result?.data || [];
        const totals = calculateTransactionTotals(transactions);
        container.innerHTML = renderTransactionsTable(transactions, totals);
        return totals;
      } catch (error) {
        console.error('Failed to load institution transactions', error);
        container.innerHTML = `<p class="text-muted">${t('wallet.transactions.failed_to_load')}</p>`;
        return null;
      }
    }

    async function applyInstitutionTransactionFilters() {
      const fromInput = document.getElementById('institutionFromDate');
      const toInput = document.getElementById('institutionToDate');
      transactionFilters.institution.fromDate = fromInput?.value || '';
      transactionFilters.institution.toDate = toInput?.value || '';
      if (currentUser?.institutionId) {
        const totals = await loadInstitutionTransactions(currentUser.institutionId);
        const active = isInstitutionFilterActive();
        transactionTotals.institution = active ? totals : null;
        updateSummaryDelta('institution', transactionTotals.institution, active);
      }
      updateTransactionFilterSummary('institution');
    }

    async function resetInstitutionTransactionFilters() {
      const fromInput = document.getElementById('institutionFromDate');
      const toInput = document.getElementById('institutionToDate');
      if (fromInput) fromInput.value = '';
      if (toInput) toInput.value = '';
      transactionFilters.institution.fromDate = '';
      transactionFilters.institution.toDate = '';
      if (currentUser?.institutionId) {
        await loadInstitutionTransactions(currentUser.institutionId);
      }
      transactionTotals.institution = null;
      updateSummaryDelta('institution', null, false);
      updateTransactionFilterSummary('institution');
    }

    async function renderSuperAdminView() {
      currentView = 'superAdmin';
      renderLoadingState();
      try {
        allWalletsData = await api.wallets.getAll();
        allWalletsData = Array.isArray(allWalletsData) ? allWalletsData : [];
        const shortcut = renderFundingShortcut();

        walletContent.innerHTML = `
          ${shortcut}
          <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
              <h2 class="text-2xl font-bold text-white">${t('wallet.super_admin_title')}</h2>
            </div>
            ${renderWalletStats(allWalletsData)}
          </div>

          <div class="glass-card p-6">
            <div class="flex flex-wrap items-center gap-4 mb-4" style="display:flex; flex-wrap:wrap; align-items:center; gap:1rem; margin-bottom:1.5rem;">
              <div>
                <label class="text-sm text-muted" for="walletOwnerFilter">${t('wallet.filter_label')}</label>
                <select id="walletOwnerFilter" class="input" style="min-width:180px;">
                  <option value="all">${t('wallet.filter_all')}</option>
                  <option value="institution">${t('wallet.owner_types.institution')}</option>
                  <option value="branch">${t('wallet.owner_types.branch')}</option>
                </select>
              </div>
              <div style="flex:1; min-width:220px;">
                <label class="text-sm text-muted" for="walletSearchInput">${t('common.label.search')}</label>
                <input id="walletSearchInput" type="text" class="input" placeholder="${t('wallet.search_placeholder')}">
              </div>
            </div>
            <div id="walletsTableContainer"></div>
          </div>
        `;

        document.getElementById('walletOwnerFilter').addEventListener('change', applyWalletFilters);
        document.getElementById('walletSearchInput').addEventListener('input', applyWalletFilters);

        renderWalletsTable(allWalletsData);
      } catch (error) {
        console.error('Failed to load wallets overview', error);
        renderMessageCard(t('wallet.failed_to_load'), 'error');
      }
    }

    function renderWalletStats(data) {
      const totalWallets = data.length;
      const institutionWallets = data.filter((item) => item.ownerType === 'institution').length;
      const branchWallets = totalWallets - institutionWallets;
      const totalBalance = data.reduce((sum, item) => sum + toNumber(item.wallet?.totalBalance), 0);
      const totalCurrentProfit = data.reduce((sum, item) => sum + toNumber(item.wallet?.profitBalance), 0);
      const totalExpectedProfit = data.reduce(
        (sum, item) => sum + toNumber(item.wallet?.expectedProfitBalance ?? item.wallet?.profitBalance),
        0,
      );

      return `
        <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem;">
          ${createStatCard(t('wallet.total_wallets'), totalWallets.toLocaleString())}
          ${createStatCard(t('wallet.institution_wallets'), institutionWallets.toLocaleString())}
          ${createStatCard(t('wallet.branch_wallets'), branchWallets.toLocaleString())}
          ${createStatCard(t('wallet.total_balance'), formatCurrency(totalBalance))}
          ${createStatCard(t('wallet.current_profit_balance'), formatCurrency(totalCurrentProfit))}
          ${createStatCard(t('wallet.expected_profit_balance'), formatCurrency(totalExpectedProfit))}
        </div>
      `;
    }

    function createStatCard(label, value) {
      return `
        <div class="glass-card p-4" style="background: rgba(15,23,42,0.6);">
          <p class="text-sm text-muted">${label}</p>
          <p class="text-2xl font-bold text-white">${value}</p>
        </div>
      `;
    }

    function applyWalletFilters() {
      const typeFilter = document.getElementById('walletOwnerFilter').value;
      const searchValue = document.getElementById('walletSearchInput').value.trim().toLowerCase();

      let filtered = [...allWalletsData];
      if (typeFilter !== 'all') {
        filtered = filtered.filter((item) => item.ownerType === typeFilter);
      }

      if (searchValue) {
        filtered = filtered.filter((item) => {
          const ownerName = (item.ownerType === 'branch' ? item.branch?.name : item.institution?.name) || '';
          const institutionName = item.branch?.institutionName || item.institution?.name || '';
          return (
            ownerName.toLowerCase().includes(searchValue) ||
            institutionName.toLowerCase().includes(searchValue)
          );
        });
      }

      renderWalletsTable(filtered);
    }

    function isBranchFilterActive() {
      return Boolean(transactionFilters.branch.fromDate || transactionFilters.branch.toDate);
    }

    function isInstitutionFilterActive() {
      return Boolean(transactionFilters.institution.fromDate || transactionFilters.institution.toDate);
    }

    function renderWalletsTable(rows) {
      const container = document.getElementById('walletsTableContainer');
      if (!container) return;

      if (!rows.length) {
        container.innerHTML = `<p class="text-muted">${t('wallet.no_wallets')}</p>`;
        return;
      }

      const tableRows = rows.map((item) => {
        const ownerLabel = t(`wallet.owner_types.${item.ownerType}`) || item.ownerType;
        const ownerName = item.ownerType === 'branch' ? (item.branch?.name || '—') : (item.institution?.name || '—');
        const institutionName = item.ownerType === 'branch'
          ? (item.branch?.institutionName || '—')
          : (item.institution?.name || '—');
        const updatedAt = item.wallet?.updatedAt ? formatDateTime(item.wallet.updatedAt) : '—';
        const detailLink = item.ownerType === 'branch'
          ? (item.branch?.branchId ? `branches-view.html?id=${item.branch.branchId}` : '#')
          : (item.institution?.institutionId ? `institutions-view.html?id=${item.institution.institutionId}` : '#');
        const button = detailLink === '#'
          ? `<button class="btn btn-secondary" disabled>${t('wallet.view_details')}</button>`
          : `<a href="${detailLink}" class="btn btn-secondary">${t('wallet.view_details')}</a>`;
        const currentProfit = toNumber(item.wallet?.profitBalance ?? 0);
        const expectedProfit = toNumber(item.wallet?.expectedProfitBalance ?? item.wallet?.profitBalance ?? 0);

        return `
          <tr>
            <td>${ownerLabel}</td>
            <td>${ownerName}</td>
            <td>${institutionName}</td>
            <td>${formatCurrency(item.wallet?.originalBalance || 0)}</td>
            <td>${formatCurrency(currentProfit)}</td>
            <td>${formatCurrency(expectedProfit)}</td>
            <td>${formatCurrency(item.wallet?.totalBalance || 0)}</td>
            <td>${updatedAt}</td>
            <td>${button}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>${t('wallet.owner_type')}</th>
                <th>${t('wallet.owner_name')}</th>
                <th>${t('wallet.institution_name')}</th>
                <th>${t('wallet.original_balance')}</th>
                <th>${t('wallet.current_profit_balance')}</th>
                <th>${t('wallet.expected_profit_balance')}</th>
                <th>${t('wallet.total_balance')}</th>
                <th>${t('wallet.updated_at')}</th>
                <th>${t('common.label.actions')}</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
          </table>
        </div>
      `;
    }

    function createSummaryGrid(wallet = {}, context = 'branch') {
      const expectedProfit = wallet?.expectedProfitBalance ?? wallet?.profitBalance ?? 0;
      const currentProfit = wallet?.profitBalance ?? 0;
      const prefix = context === 'institution' ? 'institution' : 'branch';
      return `
        <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem;">
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.6);">
            <p class="text-sm text-muted">${t('wallet.original_balance')}</p>
            <p class="text-2xl font-bold text-white" id="${prefix}-original-balance">${formatCurrency(wallet.originalBalance || 0)}</p>
            <div class="text-sm" id="${prefix}-original-delta" style="min-height:18px;"></div>
          </div>
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.6);">
            <p class="text-sm text-muted">${t('wallet.current_profit_balance')}</p>
            <p class="text-2xl font-bold text-white" id="${prefix}-profit-balance">${formatCurrency(currentProfit)}</p>
            <div class="text-sm" id="${prefix}-profit-delta" style="min-height:18px;"></div>
          </div>
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.6);">
            <p class="text-sm text-muted">${t('wallet.expected_profit_balance')}</p>
            <p class="text-2xl font-bold text-white" id="${prefix}-expected-profit">${formatCurrency(expectedProfit)}</p>
            <div class="text-sm" id="${prefix}-expected-delta" style="min-height:18px;"></div>
          </div>
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.6);">
            <p class="text-sm text-muted">${t('wallet.total_balance')}</p>
            <p class="text-2xl font-bold text-white" id="${prefix}-total-balance">${formatCurrency(wallet.totalBalance || 0)}</p>
            <div class="text-sm" id="${prefix}-total-delta" style="min-height:18px;"></div>
          </div>
        </div>
      `;
    }

    function updateSummaryDelta(context, totals, isFiltered) {
      const prefix = context === 'institution' ? 'institution' : 'branch';
      const filterBadge = document.getElementById(`${prefix}-summary-filter`);
      const filterNote = document.getElementById(`${prefix}-summary-note`);
      const originalDelta = document.getElementById(`${prefix}-original-delta`);
      const profitDelta = document.getElementById(`${prefix}-profit-delta`);
      const totalDelta = document.getElementById(`${prefix}-total-delta`);
      const expectedDelta = document.getElementById(`${prefix}-expected-delta`);

      const active = Boolean(isFiltered && totals);

      if (filterBadge) {
        filterBadge.style.display = active ? 'inline-flex' : 'none';
      }
      if (filterNote) {
        filterNote.textContent = active ? t('wallet.summary_filtered_note') : '';
      }

      if (originalDelta) {
        originalDelta.innerHTML = active ? formatDeltaValue(totals.original) : '';
      }
      if (profitDelta) {
        profitDelta.innerHTML = active ? formatDeltaValue(totals.profit) : '';
      }
      if (totalDelta) {
        totalDelta.innerHTML = active ? formatDeltaValue(totals.total) : '';
      }
      if (expectedDelta) {
        expectedDelta.innerHTML = active ? formatDeltaValue(totals.profit) : '';
      }
    }

    function calculateTransactionTotals(rows = []) {
      return rows.reduce((acc, tx) => {
        acc.original += toNumber(tx.originalDelta);
        acc.profit += toNumber(tx.profitDelta);
        acc.total += toNumber(tx.totalDelta);
        return acc;
      }, { original: 0, profit: 0, total: 0 });
    }

    function renderTransactionsTable(rows, totals) {
      const safeRows = Array.isArray(rows) ? rows : [];
      const hasRows = safeRows.length > 0;
      const showTotals = Boolean(totals);
      const totalsSection = showTotals ? `
        <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.5);">
            <p class="text-sm text-muted">${t('wallet.transactions.original_total')}</p>
            <p class="text-xl font-semibold">${formatDeltaValue(totals.original)}</p>
          </div>
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.5);">
            <p class="text-sm text-muted">${t('wallet.transactions.profit_total')}</p>
            <p class="text-xl font-semibold">${formatDeltaValue(totals.profit)}</p>
          </div>
          <div class="glass-card p-4" style="background: rgba(30,41,59,0.5);">
            <p class="text-sm text-muted">${t('wallet.transactions.net_total')}</p>
            <p class="text-xl font-semibold">${formatDeltaValue(totals.total)}</p>
          </div>
        </div>
      ` : '';

      if (!hasRows) {
        return `
          ${showTotals ? `<p class="text-muted" style="margin-bottom:0.5rem;">${t('wallet.transactions.filtered_totals')}</p>` : ''}
          ${totalsSection}
          <p class="text-muted">${t('wallet.transactions.empty')}</p>
        `;
      }

      const tableRows = safeRows.map((tx) => `
        <tr>
          <td>${formatTransactionType(tx.transactionType)}</td>
          <td>${formatDeltaValue(tx.originalDelta)}</td>
          <td>${formatDeltaValue(tx.profitDelta)}</td>
          <td>${formatDeltaValue(tx.totalDelta)}</td>
          <td>${translateTransactionDescription(tx.description)}</td>
          <td>${formatDateTime(tx.createdAt)}</td>
        </tr>
      `).join('');

      return `
        ${showTotals ? `<p class="text-muted" style="margin-bottom:0.5rem;">${t('wallet.transactions.filtered_totals')}</p>` : ''}
        ${totalsSection}
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>${t('wallet.transactions.type')}</th>
                <th>${t('wallet.transactions.original')}</th>
                <th>${t('wallet.transactions.profit')}</th>
                <th>${t('wallet.transactions.total')}</th>
                <th>${t('wallet.transactions.description')}</th>
                <th>${t('wallet.transactions.created_at')}</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
          </table>
        </div>
      `;
    }

    function formatTransactionType(type) {
      if (!type) return t('wallet.transaction_types.manual_adjustment');
      const key = `wallet.transaction_types.${type.toLowerCase()}`;
      return t(key) || type;
    }

    function formatDeltaValue(value) {
      const amount = toNumber(value);
      const formatted = formatCurrency(Math.abs(amount));
      const prefix = amount >= 0 ? '+' : '-';
      return `<span class="${amount >= 0 ? 'text-success' : 'text-danger'}">${prefix} ${formatted}</span>`;
    }

    function toNumber(value) {
      const numeric = Number(value);
      return Number.isNaN(numeric) ? 0 : numeric;
    }

    function translateTransactionDescription(description) {
      if (!description) return '—';
      const sanitized = escapeHtml(description);
      const locale = window.i18n?.getCurrentLocale?.() || 'en';
      if (locale !== 'ar') {
        return sanitized;
      }

      for (const pattern of TRANSACTION_DESCRIPTION_PATTERNS) {
        const match = sanitized.match(pattern.regex);
        if (match) {
          return pattern.transform(match);
        }
      }

      let translated = sanitized;
      Object.entries(TRANSACTION_DESCRIPTION_DICTIONARY).forEach(([english, arabic]) => {
        const regex = new RegExp(`\\b${escapeRegExp(english)}\\b`, 'gi');
        translated = translated.replace(regex, arabic);
      });
      return translated;
    }

    function escapeHtml(unsafeText) {
      return unsafeText.replace(/[&<>"']/g, (char) => {
        switch (char) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case '\'': return '&#39;';
          default: return char;
        }
      });
    }

    function escapeRegExp(text) {
      return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>
</body>
</html>
