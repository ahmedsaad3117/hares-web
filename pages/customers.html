<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers - Q1KEY Platform</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/i18n.js"></script>
</head>
<body>
  <div id="sidebar"></div>
  
  <div class="main-content">
    <div id="header"></div>
    
    <div class="page-content">
      <!-- Page Header -->
      <div class="flex items-center justify-between mb-8" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
        <div class="flex items-center gap-3" style="display: flex; align-items: center; gap: 0.75rem;">
          <div style="font-size: 2rem;">ðŸ‘¥</div>
          <div>
            <h1 class="text-3xl font-bold text-white" data-i18n-key="customers.title">${t('customers.title')}</h1>
            <p class="text-secondary" data-i18n-key="customers.customer_details">${t('customers.customer_details')}</p>
          </div>
        </div>
        <a href="customers-new.html" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          <span data-i18n-key="customers.add_customer">${t('customers.add_customer')}</span>
        </a>
      </div>
      
      <!-- Search Bar -->
      <div class="glass-card p-4 mb-6">
        <div style="position: relative;">
          <svg style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: #94a3b8;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input 
            type="text" 
            id="searchInput"
            placeholder="" 
            class="input"
            style="padding-left: 3rem;"
          />
        </div>
      </div>
      
      <!-- Customers Grid -->
      <div id="customersGrid" class="grid grid-cols-3 gap-4" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="loading-container" style="grid-column: 1 / -1;">
          <div class="spinner"></div>
        </div>
      </div>
      
      <!-- Pagination -->
      <div id="paginationContainer" class="flex justify-center" style="display: flex; justify-content: center; margin-top: 2rem;"></div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../components/sidebar.js"></script>
  <script src="../components/header.js"></script>
  <script src="../components/pagination.js"></script>
  <script>
    async function initPage() {
      await waitForI18n();
      
      // Check authentication
      if (!isAuthenticated()) {
        window.location.href = '../index.html';
        return;
      }
      
      user = getCurrentUser(); // Set global user variable
      document.getElementById('sidebar').innerHTML = createSidebar(user);
      document.getElementById('header').innerHTML = createHeader(
        t('customers.title'),
        t('customers.customer_details')
      );
      initializeLanguageSwitcher();
      setActiveNav('customers');
      
      // Set search placeholder after i18n is ready
      document.getElementById('searchInput').placeholder = t('customers.search_placeholder');
      
      // Load customers with pagination
      loadCustomers();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
    
    let user = null; // Global user variable
    let allCustomers = [];
    let currentPage = 1;
    let totalPages = 1;
    const pageSize = 12;
    
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(performSearch, 500);
    });
    
    async function loadCustomers(page = 1) {
      try {
        const response = await api.customers.getAll(page, pageSize);
        allCustomers = response.data;
        currentPage = response.meta.page;
        totalPages = response.meta.totalPages;
        renderCustomers(allCustomers);
      } catch (error) {
        console.error('Error loading customers:', error);
        showToast(t('customers.failed_to_load'), 'error');
        document.getElementById('customersGrid').innerHTML = `<p class="text-muted" style="grid-column: 1 / -1; text-align: center;">${t('customers.failed_to_load')}</p>`;
      }
    }
    
    async function performSearch() {
      const searchTerm = searchInput.value.trim();
      
      if (!searchTerm) {
        loadCustomers(1);
        return;
      }
      
      try {
        // Show loading indicator
        document.getElementById('customersGrid').innerHTML = `
          <div class="glass-card p-6" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p class="text-muted" style="margin-top: 1rem;">${t('customers.searching')}</p>
          </div>
        `;
        
        // Call the search API
        const results = await api.customers.search({
          name: searchTerm,
          nationalId: searchTerm,
          phoneNumber: searchTerm
        });
        
        allCustomers = results;
        currentPage = 1;
        totalPages = 1;
        renderCustomers(results);
        
        if (results.length > 0) {
          showToast(t('customers.found_customers').replace('{count}', results.length), 'success');
        }
      } catch (error) {
        console.error('Error searching customers:', error);
        showToast(t('customers.failed_to_search'), 'error');
        document.getElementById('customersGrid').innerHTML = `<p class="text-muted" style="grid-column: 1 / -1; text-align: center;">${t('customers.failed_to_search')}</p>`;
      }
    }
    
    function changePage(page) {
      if (page < 1 || page > totalPages || page === currentPage) return;
      loadCustomers(page);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function renderCustomers(customers) {
      const grid = document.getElementById('customersGrid');
      
      if (customers.length === 0) {
        grid.innerHTML = `
          <div class="glass-card p-6" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
            <svg style="width: 64px; height: 64px; margin: 0 auto 1rem; color: #475569;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <p class="text-muted">${searchInput.value ? t('customers.no_customers_found') : t('customers.no_customers')}</p>
          </div>
        `;
        return;
      }
      
      const customersHTML = customers.map(customer => `
        <div class="glass-card p-6" style="transition: all 0.2s ease;">
          <div class="flex items-center justify-between mb-4" style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
            <div class="flex items-center gap-3" style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #4f46e5); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.25rem;">
                ${customer.name.charAt(0).toUpperCase()}
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">${customer.name}</h3>
                <p class="text-sm text-muted">ID: ${customer.customerId}</p>
              </div>
            </div>
            ${formatTrustStatusBadge(customer.trustStatus)}
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
            <div class="flex items-center gap-2" style="display: flex; align-items: center; gap: 0.5rem; color: #cbd5e1;">
              <svg style="width: 16px; height: 16px; color: #64748b;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"/>
                <path d="M7 15h0M2 9.5h20"/>
              </svg>
              <span class="text-sm">${customer.nationalId}</span>
            </div>
            <div class="flex items-center gap-2" style="display: flex; align-items: center; gap: 0.5rem; color: #cbd5e1;">
              <svg style="width: 16px; height: 16px; color: #64748b;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
              </svg>
              <span class="text-sm">${customer.phoneNumber}</span>
            </div>
          </div>
          
          <div class="flex items-center gap-2" style="display: flex; align-items: center; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <a href="customers-view.html?id=${customer.customerId}" class="btn btn-secondary" style="flex: 1; font-size: 0.875rem; padding: 0.5rem 1rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              ${t('customers.view')}
            </a>
            ${user.roleName === 'Super Admin' || customer.createdBy === user.userId ? `
              <a href="customers-edit.html?id=${customer.customerId}" class="btn btn-secondary" style="flex: 1; font-size: 0.875rem; padding: 0.5rem 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                </svg>
                ${t('customers.edit')}
              </a>
              <button onclick="deleteCustomer(${customer.customerId})" class="btn btn-danger" style="font-size: 0.875rem; padding: 0.5rem 0.75rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
      
      grid.innerHTML = customersHTML;
      
      // Render pagination
      const paginationContainer = document.getElementById('paginationContainer');
      if (paginationContainer) {
        paginationContainer.innerHTML = createPagination(currentPage, totalPages, changePage);
      }
    }
    
    async function deleteCustomer(id) {
      if (!confirm(t('customers.delete_confirmation'))) return;
      
      try {
        await api.customers.delete(id);
        showToast(t('customers.deleted_success'), 'success');
        loadCustomers(currentPage);
      } catch (error) {
        console.error('Error deleting customer:', error);
        showToast(t('customers.delete_failed'), 'error');
      }
    }
  </script>
</body>
</html>
